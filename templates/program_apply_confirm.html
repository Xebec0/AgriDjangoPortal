{% extends 'base.html' %}

{% block title %}Confirm Application - AgroStudies{% endblock %}

{% block extra_css %}
<style>
    .info-section {
        border-bottom: 1px solid #eee;
        padding-bottom: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .info-section:last-child {
        border-bottom: none;
    }
    
    .info-section-title {
        margin-bottom: 1rem;
        color: #0275d8;
        font-weight: 600;
    }
    
    .info-row {
        display: flex;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .info-label {
        font-weight: 600;
        min-width: 200px;
        color: #495057;
    }
    
    .info-value {
        flex: 1;
        color: #212529;
    }
    
    .missing-info {
        color: #dc3545;
        font-style: italic;
    }
    
    .program-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">Confirm Your Application</h1>
        <a href="{% url 'program_detail' program.id %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Program
        </a>
    </div>

    <!-- Program Information -->
    <div class="program-card shadow">
        <h3 class="mb-3"><i class="fas fa-seedling me-2"></i>{{ program.title }}</h3>
        <p class="mb-2"><i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> {{ program.location }}</p>
        <p class="mb-2"><i class="fas fa-calendar-alt me-2"></i><strong>Start Date:</strong> {{ program.start_date|date:"F d, Y" }}</p>
        <p class="mb-0"><i class="fas fa-users me-2"></i><strong>Available Slots:</strong> {{ program.capacity }}</p>
    </div>

    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="fas fa-user-check me-2"></i>Review Your Information</h5>
        </div>
        <div class="card-body">
            {% if missing_fields %}
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Missing Information:</strong> The following fields are not yet provided: <strong>{{ missing_fields|join:", " }}</strong>.
                You can still submit your application, but please complete these fields as soon as possible.
                Click the "Edit Information" button below to update your details.
            </div>
            {% endif %}
            
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>Please review your information below.</strong> This data was collected from your profile. 
                You can edit your information directly on this page using the "Edit Information" button.
            </div>
            
            <!-- Inline Profile Edit Form (Collapsible) -->
            <div class="collapse mb-4" id="editProfileSection">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Edit Your Information</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">Update your information below. Changes will be saved to your profile.</p>
                        
                        <form method="POST" action="{% url 'profile' %}" id="quickEditForm" target="_self">
                            {% csrf_token %}
                            
                            <!-- Personal Details -->
                            <h6 class="text-primary mt-3 mb-3"><i class="fas fa-user me-2"></i>Personal Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Date of Birth <span class="text-danger">*</span></label>
                                    <input type="date" name="date_of_birth" class="form-control" value="{{ profile.date_of_birth|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Gender <span class="text-danger">*</span></label>
                                    <select name="gender" class="form-control">
                                        <option value="">Select Gender</option>
                                        <option value="Male" {% if profile.gender == 'Male' %}selected{% endif %}>Male</option>
                                        <option value="Female" {% if profile.gender == 'Female' %}selected{% endif %}>Female</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Country of Birth <span class="text-danger">*</span></label>
                                    <input type="text" name="country_of_birth" class="form-control" value="{{ profile.country_of_birth }}" placeholder="e.g., Philippines">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Nationality <span class="text-danger">*</span></label>
                                    <input type="text" name="nationality" class="form-control" value="{{ profile.nationality }}" placeholder="e.g., Filipino">
                                </div>
                            </div>
                            
                            <!-- Passport Information -->
                            <h6 class="text-primary mt-4 mb-3"><i class="fas fa-passport me-2"></i>Passport Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Passport Number <span class="text-danger">*</span></label>
                                    <input type="text" name="passport_number" class="form-control" value="{{ profile.passport_number }}" placeholder="Enter passport number">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Issue Date <span class="text-danger">*</span></label>
                                    <input type="date" name="passport_issue_date" class="form-control" value="{{ profile.passport_issue_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Expiry Date <span class="text-danger">*</span></label>
                                    <input type="date" name="passport_expiry_date" class="form-control" value="{{ profile.passport_expiry_date|date:'Y-m-d' }}">
                                </div>
                            </div>
                            
                            <!-- Academic Information -->
                            <h6 class="text-primary mt-4 mb-3"><i class="fas fa-graduation-cap me-2"></i>Academic Information</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">University <span class="text-danger">*</span></label>
                                    <select name="university" class="form-control">
                                        <option value="">Select University</option>
                                        {% for uni in universities %}
                                        <option value="{{ uni.id }}" {% if profile.university.id == uni.id %}selected{% endif %}>{{ uni.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Specialization <span class="text-danger">*</span></label>
                                    <input type="text" name="specialization" class="form-control" value="{{ profile.specialization }}" placeholder="e.g., Agriculture">
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-end gap-2 mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#editProfileSection">
                                    <i class="fas fa-times me-2"></i>Cancel
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Save Changes & Return
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <form method="post">
                {% csrf_token %}
                
                <!-- Personal Information Section -->
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-user me-2"></i> Personal Information
                    </h4>
                    
                    <div class="info-row">
                        <div class="info-label">Full Name:</div>
                        <div class="info-value">{{ user.first_name }} {{ user.last_name }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Email:</div>
                        <div class="info-value">{{ user.email }}</div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Date of Birth:</div>
                        <div class="info-value">
                            {% if profile.date_of_birth %}
                                {{ profile.date_of_birth|date:"F d, Y" }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Gender:</div>
                        <div class="info-value">
                            {% if profile.gender %}
                                {{ profile.gender }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Nationality:</div>
                        <div class="info-value">
                            {% if profile.nationality %}
                                {{ profile.nationality }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Country of Birth:</div>
                        <div class="info-value">
                            {% if profile.country_of_birth %}
                                {{ profile.country_of_birth }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if profile.father_name or profile.mother_name %}
                    <div class="info-row">
                        <div class="info-label">Parents:</div>
                        <div class="info-value">
                            {% if profile.father_name %}Father: {{ profile.father_name }}<br>{% endif %}
                            {% if profile.mother_name %}Mother: {{ profile.mother_name }}{% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Passport Information Section -->
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-passport me-2"></i> Passport Information
                    </h4>
                    
                    <div class="info-row">
                        <div class="info-label">Passport Number:</div>
                        <div class="info-value">
                            {% if profile.passport_number %}
                                {{ profile.passport_number }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Issue Date:</div>
                        <div class="info-value">
                            {% if profile.passport_issue_date %}
                                {{ profile.passport_issue_date|date:"F d, Y" }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Expiry Date:</div>
                        <div class="info-value">
                            {% if profile.passport_expiry_date %}
                                {{ profile.passport_expiry_date|date:"F d, Y" }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Passport Scan:</div>
                        <div class="info-value">
                            {% if profile.passport_scan %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.passport_scan.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Academic Information Section -->
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-graduation-cap me-2"></i> Academic Information
                    </h4>

                    <div class="info-row">
                        <div class="info-label">University:</div>
                        <div class="info-value">
                            {% if profile.university %}
                                {{ profile.university.name }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Specialization:</div>
                        <div class="info-value">
                            {% if profile.specialization %}
                                {{ profile.specialization }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>

                    {% if profile.graduation_year %}
                    <div class="info-row">
                        <div class="info-label">Graduation Year:</div>
                        <div class="info-value">{{ profile.graduation_year }}</div>
                    </div>
                    {% endif %}

                    <div class="info-row">
                        <div class="info-label">Academic Certificate:</div>
                        <div class="info-value">
                            {% if profile.academic_certificate %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.academic_certificate.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Required Documents Section -->
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-file-upload me-2"></i> Required Documents
                    </h4>

                    <div class="info-row">
                        <div class="info-label">Transcript of Records (TOR):</div>
                        <div class="info-value">
                            {% if profile.tor %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.tor.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">NC2 from TESDA:</div>
                        <div class="info-value">
                            {% if profile.nc2_tesda %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.nc2_tesda.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Diploma:</div>
                        <div class="info-value">
                            {% if profile.diploma %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.diploma.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Good Moral Character:</div>
                        <div class="info-value">
                            {% if profile.good_moral %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.good_moral.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">NBI Clearance:</div>
                        <div class="info-value">
                            {% if profile.nbi_clearance %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.nbi_clearance.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>

                    <div class="info-row">
                        <div class="info-label">Passport Scan:</div>
                        <div class="info-value">
                            {% if profile.passport_scan %}
                                <span class="badge bg-success">Uploaded</span>
                                <a href="{{ profile.passport_scan.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> View
                                </a>
                            {% else %}
                                <span class="missing-info">Not uploaded</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Additional Information Section -->
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-info-circle me-2"></i> Additional Information
                    </h4>
                    
                    <div class="info-row">
                        <div class="info-label">Smoking Habits:</div>
                        <div class="info-value">
                            {% if profile.smokes %}
                                {{ profile.smokes }}
                            {% else %}
                                Never
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Shirt Size:</div>
                        <div class="info-value">
                            {% if profile.shirt_size %}
                                {{ profile.shirt_size }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="info-row">
                        <div class="info-label">Shoes Size:</div>
                        <div class="info-value">
                            {% if profile.shoes_size %}
                                {{ profile.shoes_size }}
                            {% else %}
                                <span class="missing-info">Not provided</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- License Information -->
                {% if program.requires_license %}
                <div class="info-section">
                    <h4 class="info-section-title">
                        <i class="fas fa-id-card me-2"></i> Driver's License
                    </h4>
                    
                    <div class="info-row">
                        <div class="info-label">International License:</div>
                        <div class="info-value">
                            {% if profile.has_international_license %}
                                <span class="badge bg-success">Yes</span>
                                {% if profile.license_scan %}
                                    <a href="{{ profile.license_scan.url }}" target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                                        <i class="fas fa-eye"></i> View License
                                    </a>
                                {% endif %}
                            {% else %}
                                <span class="badge bg-danger">No</span>
                                <div class="alert alert-warning mt-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    This program requires an international driver's license. Please update your profile.
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Confirmation -->
                <div class="alert alert-warning mt-4">
                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Important Notice</h5>
                    <ul class="mb-0">
                        <li>By submitting this application, you confirm that the information provided is accurate to the best of your knowledge.</li>
                        <li>You can only apply to ONE program. Once submitted, you cannot apply to other programs.</li>
                        <li>You can complete or update missing information in your <a href="{% url 'profile' %}" class="alert-link" target="_blank">profile page</a> even after submitting your application.</li>
                        <li>Please ensure all required documents and information are complete before the program start date.</li>
                    </ul>
                </div>
                
                <div class="form-check mb-4">
                    <input class="form-check-input" type="checkbox" id="confirmAccuracy" required>
                    <label class="form-check-label" for="confirmAccuracy">
                        <strong>I confirm that all the information above is accurate and I understand that I can only apply to one program.</strong>
                    </label>
                </div>
                
                <!-- Submit Button -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                    <button type="button" class="btn btn-outline-primary btn-lg" data-bs-toggle="collapse" data-bs-target="#editProfileSection" id="editBtn">
                        <i class="fas fa-edit me-2"></i> Edit Information
                    </button>
                    <button type="submit" class="btn btn-success btn-lg px-5" id="submitBtn" disabled>
                        <i class="fas fa-check-circle me-2"></i> Confirm & Submit Application
                    </button>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Tip: Click "Edit Information" to modify your details directly on this page.
                    </small>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const checkbox = document.getElementById('confirmAccuracy');
        const submitBtn = document.getElementById('submitBtn');
        const editBtn = document.getElementById('editBtn');
        const editSection = document.getElementById('editProfileSection');
        
        checkbox.addEventListener('change', function() {
            submitBtn.disabled = !this.checked;
        });
        
        // Update button text when edit section is toggled
        editBtn.addEventListener('click', function() {
            setTimeout(() => {
                if (editSection.classList.contains('show')) {
                    editBtn.innerHTML = '<i class="fas fa-chevron-up me-2"></i> Hide Edit Form';
                } else {
                    editBtn.innerHTML = '<i class="fas fa-edit me-2"></i> Edit Information';
                }
            }, 100);
        });
        
        // Handle quick edit form submission
        const quickEditForm = document.getElementById('quickEditForm');
        if (quickEditForm) {
            quickEditForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(this);
                
                fetch('{% url "profile" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // Show success message and reload page to reflect changes
                        alert('✓ Profile updated successfully! Reloading to show updated information...');
                        window.location.reload();
                    } else {
                        alert('⚠ Error updating profile. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('⚠ Error updating profile. Please try again.');
                });
            });
        }
    });
</script>
{% endblock %}
