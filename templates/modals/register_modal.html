<div class="modal-content">
    <div class="modal-header">
        <h5 class="modal-title" id="registerModalLabel">
            <i class="fas fa-user-plus me-2"></i> Create Account
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
    <div class="modal-body">
        <p class="text-muted mb-4">Complete your profile to apply for agricultural programs</p>
        
        <form id="registerModalForm" action="/api/ajax-register/" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            
            <!-- Step 1: Account and Personal Information -->
            <div id="step-1" class="form-step active">
                <!-- Account Information -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-user-circle me-2"></i> Account Information
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">Username <span class="text-danger">*</span></label>
                            {{ form.username }}
                            <div class="form-text small">3-20 characters: letters, numbers, underscores</div>
                            {% if form.username.errors %}
                                <div class="text-danger small">{{ form.username.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">Email <span class="text-danger">*</span></label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="text-danger small">{{ form.email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.confirm_email.id_for_label }}" class="form-label">Confirm Email <span class="text-danger">*</span></label>
                            <div class="position-relative">
                                {{ form.confirm_email }}
                                <div id="emailSuggestion" class="email-suggestion" style="display: none;">
                                    <small class="text-muted">
                                        <i class="fas fa-lightbulb me-1"></i>
                                        <span id="emailSuggestionText"></span>
                                        <button type="button" class="btn btn-link btn-sm ms-2 p-0" id="useEmailSuggestion" style="font-size: 0.75rem;">Use this</button>
                                    </small>
                                </div>
                            </div>
                            {% if form.confirm_email.errors %}
                                <div class="text-danger small">{{ form.confirm_email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.password1.id_for_label }}" class="form-label">Password <span class="text-danger">*</span></label>
                            {{ form.password1 }}
                            <div class="form-text small">8+ chars, uppercase, lowercase, numbers</div>
                            {% if form.password1.errors %}
                                <div class="text-danger small">{{ form.password1.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.password2.id_for_label }}" class="form-label">Confirm Password <span class="text-danger">*</span></label>
                            {{ form.password2 }}
                            {% if form.password2.errors %}
                                <div class="text-danger small">{{ form.password2.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Personal Information -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-id-card me-2"></i> Personal Information
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.first_name.id_for_label }}" class="form-label">First Name <span class="text-danger">*</span></label>
                            {{ form.first_name }}
                            {% if form.first_name.errors %}
                                <div class="text-danger small">{{ form.first_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.last_name.id_for_label }}" class="form-label">Last Name <span class="text-danger">*</span></label>
                            {{ form.last_name }}
                            {% if form.last_name.errors %}
                                <div class="text-danger small">{{ form.last_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.date_of_birth.id_for_label }}" class="form-label">Date of Birth <span class="text-danger">*</span></label>
                            <input type="date"
                                   id="{{ form.date_of_birth.id_for_label }}"
                                   name="{{ form.date_of_birth.name }}"
                                   class="form-control"
                                   required>
                            {% if form.date_of_birth.errors %}
                                <div class="text-danger small">{{ form.date_of_birth.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.gender.id_for_label }}" class="form-label">Sex <span class="text-danger">*</span></label>
                            {{ form.gender }}
                            {% if form.gender.errors %}
                                <div class="text-danger small">{{ form.gender.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nationality.id_for_label }}" class="form-label">Nationality <span class="text-danger">*</span></label>
                            {{ form.nationality }}
                            {% if form.nationality.errors %}
                                <div class="text-danger small">{{ form.nationality.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.phone_number.id_for_label }}" class="form-label">Phone Number</label>
                            {{ form.phone_number }}
                            <div class="form-text small">
                                <i class="fas fa-info-circle me-1"></i>
                                Numbers only: e.g., +63 912 345 6789 (spaces, dashes, parentheses allowed) Typing letters is prevented
                            </div>
                            <div class="invalid-feedback">
                                Please enter a valid phone number (numbers and standard formatting only)
                            </div>
                            <script>
                                document.getElementById('{{ form.phone_number.id_for_label }}').addEventListener('input', function(e) {
                                    const value = this.value;
                                    const isValid = /^[\d\s\-\+\(\)\.]*$/.test(value);
                                    this.classList.toggle('is-invalid', !isValid);
                                    if (!isValid) {
                                        this.value = value.replace(/[^0-9\s\-\+\(\)\.]/g, '');
                                    }
                                });
                            </script>
                            {% if form.phone_number.errors %}
                                <div class="text-danger small">{{ form.phone_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.address.id_for_label }}" class="form-label">Address</label>
                        {{ form.address }}
                        {% if form.address.errors %}
                            <div class="text-danger small">{{ form.address.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Passport and Academic Information -->
            <div id="step-2" class="form-step">
                <!-- Passport Information -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-passport me-2"></i> Passport Information
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.passport_number.id_for_label }}" class="form-label">Passport Number <span class="text-danger">*</span></label>
                            {{ form.passport_number }}
                            {% if form.passport_number.errors %}
                                <div class="text-danger small">{{ form.passport_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.confirm_passport_number.id_for_label }}" class="form-label">Confirm Passport <span class="text-danger">*</span></label>
                            {{ form.confirm_passport_number }}
                            {% if form.confirm_passport_number.errors %}
                                <div class="text-danger small">{{ form.confirm_passport_number.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.passport_issue_date.id_for_label }}" class="form-label">Issue Date <span class="text-danger">*</span></label>
                            <input type="date"
                                   id="{{ form.passport_issue_date.id_for_label }}"
                                   name="{{ form.passport_issue_date.name }}"
                                   class="form-control"
                                   required>
                            {% if form.passport_issue_date.errors %}
                                <div class="text-danger small">{{ form.passport_issue_date.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="{{ form.passport_expiry_date.id_for_label }}" class="form-label">Expiry Date <span class="text-danger">*</span></label>
                            <input type="date"
                                   id="{{ form.passport_expiry_date.id_for_label }}"
                                   name="{{ form.passport_expiry_date.name }}"
                                   class="form-control"
                                   required>
                            {% if form.passport_expiry_date.errors %}
                                <div class="text-danger small">{{ form.passport_expiry_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.place_of_issue.id_for_label }}" class="form-label">Place of Issue</label>
                            {{ form.place_of_issue }}
                            {% if form.place_of_issue.errors %}
                                <div class="text-danger small">{{ form.place_of_issue.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Academic Information -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-graduation-cap me-2"></i> Academic Information
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.highest_education_level.id_for_label }}" class="form-label">Education Level <span class="text-danger">*</span></label>
                            {{ form.highest_education_level }}
                            {% if form.highest_education_level.errors %}
                                <div class="text-danger small">{{ form.highest_education_level.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.institution_name.id_for_label }}" class="form-label">Institution Name <span class="text-danger">*</span></label>
                            {{ form.institution_name }}
                            {% if form.institution_name.errors %}
                                <div class="text-danger small">{{ form.institution_name.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.field_of_study.id_for_label }}" class="form-label">Field of Study <span class="text-danger">*</span></label>
                            {{ form.field_of_study }}
                            {% if form.field_of_study.errors %}
                                <div class="text-danger small">{{ form.field_of_study.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.graduation_year.id_for_label }}" class="form-label">Graduation Year <span class="text-danger">*</span></label>
                            {{ form.graduation_year }}
                            {% if form.graduation_year.errors %}
                                <div class="text-danger small">{{ form.graduation_year.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Additional and Documents -->
            <div id="step-3" class="form-step">
                <!-- Additional Information -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-info-circle me-2"></i> Additional Information
                    </h6>
                    
                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.willing_to_relocate }}
                            <label class="form-check-label" for="{{ form.willing_to_relocate.id_for_label }}">
                                Willing to relocate
                            </label>
                        </div>
                        {% if form.willing_to_relocate.errors %}
                            <div class="text-danger small">{{ form.willing_to_relocate.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.special_requirements.id_for_label }}" class="form-label">Special Requirements</label>
                        {{ form.special_requirements }}
                        <div class="form-text small">Dietary restrictions, medical conditions, etc.</div>
                        {% if form.special_requirements.errors %}
                            <div class="text-danger small">{{ form.special_requirements.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Document Uploads -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-file-upload me-2"></i> Documents (Optional)
                    </h6>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.profile_image.id_for_label }}" class="form-label">Profile Photo</label>
                            {{ form.profile_image }}
                            <div class="form-text small">Max 5MB</div>
                            {% if form.profile_image.errors %}
                                <div class="text-danger small">{{ form.profile_image.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.passport_scan.id_for_label }}" class="form-label">Passport Scan</label>
                            {{ form.passport_scan }}
                            <div class="form-text small">PDF/Image</div>
                            {% if form.passport_scan.errors %}
                                <div class="text-danger small">{{ form.passport_scan.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label for="{{ form.academic_certificate.id_for_label }}" class="form-label">Certificate</label>
                            {{ form.academic_certificate }}
                            <div class="form-text small">PDF/Image</div>
                            {% if form.academic_certificate.errors %}
                                <div class="text-danger small">{{ form.academic_certificate.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
        </form>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="prevBtn" style="display: none;">Previous</button>
        <span id="stepIndicator" class="align-self-center">Step 1 of 3</span>
        <button type="button" class="btn btn-primary" id="nextBtn">Next</button>
    </div>
</div>

<!-- Toast Container for Error Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
    <div id="registerToast" class="toast border-0 shadow-lg" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header" id="toastHeader">
            <i class="fas fa-exclamation-circle me-2" id="toastIcon"></i>
            <strong class="me-auto" id="toastTitle">Validation Error</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastContent">
        </div>
    </div>
</div>

<style>
.form-step {
    display: none;
}
.form-step.active {
    display: block;
}
.step-indicator {
    font-weight: 500;
    color: #6c757d;
}

/* Toast notification styles */
#registerToast {
    min-width: 350px;
    max-width: 500px;
    animation: slideInRight 0.3s ease-out;
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

#registerToast.hiding {
    animation: slideOutRight 0.3s ease-in;
}

/* Success toast styling */
#registerToast.toast-success .toast-header {
    background-color: #d4edda;
    color: #155724;
}

#registerToast.toast-success .toast-body {
    background-color: #d4edda;
    color: #155724;
}

#registerToast.toast-success #toastIcon {
    color: #28a745;
}

/* Error toast styling */
#registerToast.toast-error .toast-header {
    background-color: #f8d7da;
    color: #721c24;
}

#registerToast.toast-error .toast-body {
    background-color: #f8d7da;
    color: #721c24;
}

#registerToast.toast-error #toastIcon {
    color: #dc3545;
}

/* Warning toast styling */
#registerToast.toast-warning .toast-header {
    background-color: #fff3cd;
    color: #856404;
}

#registerToast.toast-warning .toast-body {
    background-color: #fff3cd;
    color: #856404;
}

#registerToast.toast-warning #toastIcon {
    color: #ffc107;
}

#toastContent ul {
    margin: 0.5rem 0 0 0;
    padding-left: 20px;
    list-style-type: disc;
}

#toastContent ul li {
    margin-bottom: 0.5rem;
}

#toastContent ul li:last-child {
    margin-bottom: 0;
}

#toastContent p {
    margin: 0;
}

/* Hide inline error messages - errors will show in toasts */
.text-danger.small {
    display: none !important;
}

/* Email suggestion styles */
.email-suggestion {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 0.375rem 0.375rem;
    padding: 0.5rem 0.75rem;
    z-index: 10;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.email-suggestion small {
    margin: 0;
    line-height: 1.2;
}

/* Remove Bootstrap's default validation styles for cleaner look */
.is-invalid {
    border-color: #dc3545 !important;
}

.is-valid {
    border-color: #28a745 !important;
}


</style>

<script>
// Enhanced toast notification function
function showRegisterToast(message, type = 'error', autoHide = true) {
    const toastEl = document.getElementById('registerToast');
    const toastContent = document.getElementById('toastContent');
    const toastTitle = document.getElementById('toastTitle');
    const toastIcon = document.getElementById('toastIcon');
    const toastHeader = document.getElementById('toastHeader');
    
    if (!toastEl || !toastContent || !toastTitle || !toastIcon) return;
    
    // Clear previous classes
    toastEl.classList.remove('toast-success', 'toast-error', 'toast-warning', 'hiding');
    
    // Set title and icon based on type
    switch(type) {
        case 'success':
            toastEl.classList.add('toast-success');
            toastTitle.textContent = 'Success';
            toastIcon.className = 'fas fa-check-circle me-2';
            break;
        case 'warning':
            toastEl.classList.add('toast-warning');
            toastTitle.textContent = 'Warning';
            toastIcon.className = 'fas fa-exclamation-triangle me-2';
            break;
        case 'error':
        default:
            toastEl.classList.add('toast-error');
            toastTitle.textContent = 'Validation Error';
            toastIcon.className = 'fas fa-exclamation-circle me-2';
            break;
    }
    
    // Set content
    if (typeof message === 'object' && message !== null && !Array.isArray(message)) {
        // Handle error object with multiple fields
        let html = '<ul>';
        let errorCount = 0;
        for (const [field, errors] of Object.entries(message)) {
            const fieldName = field === '__all__' ? 'Form' : field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            if (Array.isArray(errors)) {
                errors.forEach(error => {
                    html += `<li><strong>${fieldName}:</strong> ${error}</li>`;
                    errorCount++;
                });
            } else {
                html += `<li><strong>${fieldName}:</strong> ${errors}</li>`;
                errorCount++;
            }
        }
        html += '</ul>';
        toastContent.innerHTML = html;
        
        // Update title to show count
        if (errorCount > 1) {
            toastTitle.textContent = `${errorCount} Validation Errors`;
        }
    } else if (Array.isArray(message)) {
        // Handle array of errors
        let html = '<ul>';
        message.forEach(error => {
            html += `<li>${error}</li>`;
        });
        html += '</ul>';
        toastContent.innerHTML = html;
    } else {
        // Handle simple string message
        toastContent.innerHTML = `<p>${message}</p>`;
    }
    
    // Initialize and show toast with animation
    const toast = new bootstrap.Toast(toastEl, {
        autohide: autoHide,
        delay: autoHide ? (type === 'success' ? 3000 : 6000) : 999999
    });
    
    toast.show();
    
    // Add hiding class before actual hide for animation
    toastEl.addEventListener('hide.bs.toast', function() {
        toastEl.classList.add('hiding');
    }, { once: true });
}

// Phone number validation - prevent letters
document.addEventListener('DOMContentLoaded', function() {
    // Get the phone field using Django's template variable
    const phoneField = document.getElementById('{{ form.phone_number.id_for_label }}');
    if (phoneField) {
        console.log('Phone field found:', phoneField);

        phoneField.addEventListener('keypress', function(e) {
            // Allow: backspace, delete, tab, escape, enter, and phone number characters
            if (e.key === 'Backspace' || e.key === 'Delete' || e.key === 'Tab' ||
                e.key === 'Escape' || e.key === 'Enter' || e.key === 'ArrowLeft' ||
                e.key === 'ArrowRight' || e.key === 'ArrowUp' || e.key === 'ArrowDown') {
                return;
            }

            // Prevent input if it's not a number or phone formatting character
            const allowedChars = /^[0-9\s\-\+\(\)\.]$/;
            if (!allowedChars.test(e.key)) {
                e.preventDefault();
                return false;
            }
        });

        phoneField.addEventListener('paste', function(e) {
            e.preventDefault();
            let pasteText = e.clipboardData.getData('text/plain');
            // Only allow numbers and phone formatting characters
            pasteText = pasteText.replace(/[^0-9\s\-\+\(\)\.]/g, '');
            this.value = pasteText;
        });

        phoneField.addEventListener('input', function(e) {
            // Remove any non-allowed characters as user types
            let value = this.value;
            let cleanValue = value.replace(/[^0-9\s\-\+\(\)\.]/g, '');
            if (value !== cleanValue) {
                this.value = cleanValue;
            }
        });

        phoneField.addEventListener('focus', function() {
            console.log('Phone field focused');
        });

        phoneField.addEventListener('keypress', function(e) {
            console.log('Phone keypress:', e.key, 'Allowed:', /^[0-9\s\-\+\(\)\.]$/.test(e.key));
        });
    } else {
        console.error('Phone field NOT found! Looking for {{ form.phone_number.id_for_label }}');
    }
});

document.getElementById('id_confirm_email')?.addEventListener('blur', function() {
    // Hide suggestion after a short delay to allow clicking the "Use this" button
    setTimeout(() => {
        const suggestionDiv = document.getElementById('emailSuggestion');
        if (suggestionDiv) {
            suggestionDiv.style.display = 'none';
        }
    }, 150);
});

document.getElementById('useEmailSuggestion')?.addEventListener('click', function(e) {
    e.preventDefault();
    const emailField = document.getElementById('id_email');
    const confirmEmailField = document.getElementById('id_confirm_email');
    const suggestionDiv = document.getElementById('emailSuggestion');

    if (emailField && confirmEmailField) {
        confirmEmailField.value = emailField.value.trim();
        confirmEmailField.classList.remove('is-invalid');
        confirmEmailField.classList.add('is-valid');
        suggestionDiv.style.display = 'none';
        confirmEmailField.focus();
    }
});

// Form validation on step navigation
document.getElementById('nextBtn')?.addEventListener('click', function() {
    const currentStep = document.querySelector('.form-step.active');
    const stepNumber = currentStep.id.split('-')[1];

    let errors = {};
    let hasErrors = false;

    // Define required fields for each step
    const step1RequiredFields = [
        'id_username', 'id_first_name', 'id_last_name', 'id_email', 'id_confirm_email',
        'id_password1', 'id_password2', 'id_date_of_birth', 'id_gender', 'id_nationality'
    ];

    const step2RequiredFields = [
        'id_passport_number', 'id_confirm_passport_number', 'id_passport_issue_date',
        'id_passport_expiry_date', 'id_highest_education_level', 'id_institution_name',
        'id_field_of_study', 'id_graduation_year'
    ];

    let requiredFields = [];
    if (stepNumber === '1') {
        requiredFields = step1RequiredFields;
    } else if (stepNumber === '2') {
        requiredFields = step2RequiredFields;
    }

    // Clear previous validation states
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.classList.remove('is-invalid', 'is-valid');
        }
    });

    // Validate required fields
    requiredFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (!field.value.trim()) {
                const label = field.closest('.mb-3')?.querySelector('label')?.textContent.replace('*', '').trim() || field.name;
                errors[label] = ['This field is required.'];
                hasErrors = true;
                field.classList.add('is-invalid');
            } else {
                field.classList.add('is-valid');
            }
        }
    });

    // Additional validation for specific fields
    if (stepNumber === '1') {
        // Validate email match
        const email = document.getElementById('id_email');
        const confirmEmail = document.getElementById('id_confirm_email');
        if (email && confirmEmail && email.value && confirmEmail.value && email.value !== confirmEmail.value) {
            errors['Confirm Email'] = ['Emails do not match.'];
            confirmEmail.classList.add('is-invalid');
            hasErrors = true;
        }

        // Validate password match
        const password1 = document.getElementById('id_password1');
        const password2 = document.getElementById('id_password2');
        if (password1 && password2 && password1.value && password2.value && password1.value !== password2.value) {
            errors['Confirm Password'] = ['Passwords do not match.'];
            password2.classList.add('is-invalid');
            hasErrors = true;
        }

        // Validate date of birth
        const dob = document.getElementById('id_date_of_birth');
        if (dob && dob.value) {
            const birthDate = new Date(dob.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (birthDate >= today) {
                errors['Date of Birth'] = ['Date of birth must be in the past.'];
                dob.classList.add('is-invalid');
                hasErrors = true;
            }

            if (birthDate.getFullYear() < 1900) {
                errors['Date of Birth'] = ['Please enter a valid date of birth.'];
                dob.classList.add('is-invalid');
                hasErrors = true;
            }
        }
    }

    if (stepNumber === '2') {
        // Validate passport match
        const passport = document.getElementById('id_passport_number');
        const confirmPassport = document.getElementById('id_confirm_passport_number');
        if (passport && confirmPassport && passport.value && confirmPassport.value && passport.value !== confirmPassport.value) {
            errors['Confirm Passport'] = ['Passport numbers do not match.'];
            confirmPassport.classList.add('is-invalid');
            hasErrors = true;
        }

        // Validate passport dates
        const issueDate = document.getElementById('id_passport_issue_date');
        const expiryDate = document.getElementById('id_passport_expiry_date');
        if (issueDate && expiryDate && issueDate.value && expiryDate.value) {
            const issue = new Date(issueDate.value);
            const expiry = new Date(expiryDate.value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            if (expiry <= issue) {
                errors['Passport Expiry Date'] = ['Expiry date must be after issue date.'];
                expiryDate.classList.add('is-invalid');
                hasErrors = true;
            }

            if (expiry < today) {
                errors['Passport Expiry Date'] = ['Passport must not be expired.'];
                expiryDate.classList.add('is-invalid');
                hasErrors = true;
            }
        }
    }

    if (hasErrors) {
        showRegisterToast(errors, 'error', true);
        // Scroll to first invalid field
        const firstInvalid = currentStep.querySelector('.is-invalid');
        if (firstInvalid) {
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus();
        }
        return;
    }

    // Move to next step or submit
    if (stepNumber < 3) {
        currentStep.classList.remove('active');
        document.getElementById(`step-${parseInt(stepNumber) + 1}`).classList.add('active');
        document.getElementById('stepIndicator').textContent = `Step ${parseInt(stepNumber) + 1} of 3`;
        document.getElementById('prevBtn').style.display = 'inline-block';

        if (parseInt(stepNumber) + 1 === 3) {
            this.textContent = 'Submit';
        }
    } else {
        // Submit form
        document.getElementById('registerModalForm').submit();
    }
});

// Previous button handler
document.getElementById('prevBtn')?.addEventListener('click', function() {
    const currentStep = document.querySelector('.form-step.active');
    const stepNumber = currentStep.id.split('-')[1];

    if (stepNumber > 1) {
        currentStep.classList.remove('active');
        document.getElementById(`step-${parseInt(stepNumber) - 1}`).classList.add('active');
        document.getElementById('stepIndicator').textContent = `Step ${parseInt(stepNumber) - 1} of 3`;
        document.getElementById('nextBtn').textContent = 'Next';

        if (parseInt(stepNumber) - 1 === 1) {
            this.style.display = 'none';
        }
    }
});


</script>
